<tal:block tal:define="dummy python:request.set('disable_border', True)"/><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">
<head>
  <metal:js fill-slot="javascript_head_slot">
  <script type="text/javascript" tal:condition="view/amount">
    var stripeResponseHandler = function(status, response) {
      var $form = $('#checkout-form');
 
      if (response.error) {
        // Show the errors on the form
        $form.find('.checkout-errors').show().text(response.error.message);
        $form.find('input[type="submit"]').prop('disabled', false);
      } else {
        // token contains id, last4, and card type
        var token = response.id;
        // Insert the token into the form so it gets submitted to the server
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        // and re-submit
        $form.get(0).submit();
      }
    };
 
    jQuery(function($) {
      var $method = $('input[name="method"]');
      var $cc_field = $('.field-credit-card');
      var $cc_exp_field = $('.field-expiration');
      var $number_field = $('.field-number');
      var $number_label = $('label', $number_field);
      var updateForm = function() {
        var method = $method.filter(':checked').val() || 'Online Payment';
        if (method == 'Online Payment') {
          $cc_field.show(); $cc_exp_field.show(); $number_field.hide();
          $('input', $cc_field).prop('required', true);
          $('select', $cc_exp_field).prop('required', true);
        } else if (method == 'Check') {
          $cc_field.hide(); $cc_exp_field.hide(); $number_field.show();
          $number_label.html('Check #');
          $('input', $cc_field).prop('required', false);
          $('select', $cc_exp_field).prop('required', false);
        } else {
          $cc_field.hide(); $cc_exp_field.hide(); $number_field.show();
          $number_label.html('Receipt #');
          $('input', $cc_field).prop('required', false);
          $('select', $cc_exp_field).prop('required', false);
        }
      };
      updateForm();
      $method.click(updateForm);

      $('#checkout-form').submit(function(e) {
        // don't submit to Stripe if entering check or cash
        var method = $method.filter(':checked').val() || 'Online Payment';
        if (method != 'Online Payment') return true;

        var $form = $(this);
 
        // Disable the submit button to prevent repeated clicks
        $form.find('input[type="submit"]').prop('disabled', true);
 
        Stripe.createToken($form, stripeResponseHandler);
 
        // Prevent the form from submitting with the default action
        return false;
      });
    });
  </script>
  </metal:js>
</head>

<body>

<metal:main fill-slot="main">
    <h1 class="documentFirstHeading">Check out</h1>

    <tal:block tal:replace="structure view/cart_template" />

    <p class="subtotal">
      <big>
        Your purchases total:
        <strong tal:content="python:'${:,.2f}'.format(view.amount)"></strong>
      </big>
    </p>

    <form method="post" tal:attributes="action string:${portal_state/navigation_root_url}/checkout" id="checkout-form" class="jaz-shop-checkout-form">
      <input type="hidden" name="amount" tal:attributes="value view/amount" />
      <input type="hidden" name="submitted" value="1"/>

      <div class="checkout-errors error"
           tal:content="view/error"
           tal:attributes="style python:'display: none;;' if not view.error else ''" />

      <fieldset class="fieldset-contact-info jaz-shop-half-form">
        <legend><span class="step">1.</span> Billing Address</legend>

        <div class="field field-address">
          <div class="field-inputs">
            <div class="field subfield-first-name">
              <label>First name</label>
              <input type="text" name="first_name" required="required" tal:attributes="value python: view.request.form.get('first_name', None)" />
            </div>
            <div class="field subfield-last-name">
              <label>Last name</label>
              <input type="text" name="last_name" required="required" tal:attributes="value python: view.request.form.get('last_name', None)" />
            </div>
            <div class="field subfield-address">
              <label>Address</label>
              <input type="text" name="address" required="required" tal:attributes="value python: view.request.form.get('address', None)" />
            </div>
            <div class="field subfield-city">
              <label>City</label>
              <input type="text" name="city" required="required" tal:attributes="value python: view.request.form.get('city', None)" />
            </div>
            <div class="field subfield-state">
              <label>State</label>
              <input type="text" name="state" required="required" tal:attributes="value python: view.request.form.get('state', None)"/>
            </div>
            <div class="field subfield-zip">
              <label>Postal code</label>
              <input type="text" name="zip" required="required" tal:attributes="value python: view.request.form.get('zip', None)" />
            </div>
            <div class="field subfield-country"
                 tal:define="value request/country|string:United States">
              <label>Country</label>
              <select name="country" required="required">
                <option tal:repeat="country view/countries" 
                        tal:content="country"
                        tal:attributes="value country; selected python:'selected' if country == value else None">United States</option>
              </select>
            </div>
            <div class="field subfield-email">
              <label>Email</label>
              <input type="email" name="email" required="required" tal:attributes="value python:request.form.get('email', '')" />
            </div>
            <div class="field subfield-phone">
              <label>Phone</label>
              <input type="text" name="phone" tal:attributes="value python:request.form.get('phone', '')"/>
            </div>
          </div>
        </div>
      </fieldset>
        
      <fieldset class="fieldset-payment-info jaz-shop-half-form" tal:condition="view/amount">
        <legend>
          <span class="step">2.</span> Payment Information
        </legend>
        
        <div class="field"
             tal:define="value python:request.form.get('method', 'Online Payment')"
             tal:condition="view/is_superuser">
          <div class="field-inputs">
            <label>Payment Method</label>
            &nbsp;<label><input type="radio" name="method" value="Online Payment" tal:attributes="checked python:'checked' if value == 'Online Payment' else None" /> Card</label>
            &nbsp;<label><input type="radio" name="method" value="Check" tal:attributes="checked python:'checked' if value == 'Check' else None" /> Check</label>
            &nbsp;<label><input type="radio" name="method" value="Cash" tal:attributes="checked python:'checked' if value == 'Cash' else None" /> Cash</label>
          </div>
        </div>

        <div class="field field-credit-card">
          <div class="field-inputs">
            <div class="subfield subfield-card-number" style="float: left;">
              <label>Credit Card Number<br/>
              <input type="text" required="required" data-stripe="number" size="20"/>&nbsp;<img src="++resource++jazkarta.shop/credit-cards.png" title="Accepted cards: Visa, Mastercard" />&nbsp;
              </label>
            </div>
            <div class="subfield subfield-card-cvc">
              <label>CVC<br/>
                <input type="text" required="required" data-stripe="cvc" size="3" />
              </label>
            </div>
          </div>
        </div>

        <div class="field field-expiration">
          <div class="field-inputs">
            <label class="expiration-date">Expires</label>
            <div class="subfield subfield-expiration">
              <select class="card-expiration-month" required="true" data-stripe="exp-month">
                <option value="">- Month -</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
              <select class="card-expiration-year" required="required" data-stripe="exp-year">
                <option value="">- Year -</option>
                <option tal:repeat="year view/years"
                        value="${year}">${year}</option>
              </select>
            </div>
          </div>
        </div>

        <div class="field field-number" tal:condition="view/is_superuser">
          <div class="field-inputs">
            <label>Check #</label>
            <input type="text" name="number" tal:attributes="value python:request.form.get('number', '')" />
          </div>
        </div>

        <div class="field subfield-notes">
          <br />
          <label>Additional Notes</label>
          <textarea rows="3" name="notes" tal:content="python:request.form.get('notes', '')" />
        </div>

      </fieldset>

      <div class="jaz-shop-half-form jaz-shop-buttons">
        <input type="submit" value="Complete Purchase" class="allowMultiSubmit context"
               tal:attributes="disabled python:'disabled' if (not view.cart.items and not view.cart.amount) else None" />
      </div>
 
    </form>
</metal:main>
</body>
</html>
